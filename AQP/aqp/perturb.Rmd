---
title: "Simulation of Soil Morphology by Perturbation"
author: "D.E. Beaudette and A.G. Brown"
date: "`r Sys.Date()`"
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
---
  
```{r setup, echo=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE, cache = FALSE, fig.align = 'center')
options(width=100, stringsAsFactors=FALSE, cache=FALSE)
```


Setup R session.
```{r}
# latest version from github
library(aqp)
library(soilDB)
library(sharpshootR)

library(cluster)
library(MASS)
```


Get some example data.
```{r fig.width=6, fig.height=6}
# example profile
x <- fetchOSD(c('musick', 'drummer'))

# convert horizon distinctness codes into reasonable depth offsets
x$hd <- hzDistinctnessCodeToOffset(
  x$distinctness, 
  codes = c('very abrupt', 'abrupt', 'clear', 'gradual', 'diffuse')
)

# sketch using horizon boundary encoded
par(mar = c(0, 0, 0, 0))
plotSPC(x, hz.distinctness.offset = 'hd', name.style = 'center-center', plot.depth.axis = FALSE, hz.depths = TRUE)
```




Simulation from a template: perturbation of horizon boundaries based on horizon boundary distinctness.
```{r fig.width=12, fig.height=6}
# number of new IDs sets the number of realizations
s <- perturb(
  subset(x, id == 'MUSICK'), 
  id = sprintf("Sim. %02d", 1:9),
  boundary.attr = 'hd', 
  min.thickness = 5
)

# combine with original
o <- subset(x, id == 'MUSICK')

# remove original profile ID
site(s)$id <- NULL

s <- combine(
  o,
  s
)


# neat
par(mar=c(0,0,0,0))
plotSPC(s, name.style = 'center-center', plot.depth.axis = FALSE, hz.depths = TRUE, width = 0.3)
```


Align many realizations and supress all labels.
```{r fig.width=12, fig.height=6}

# simulate
s <- perturb(
  subset(x, id == 'MUSICK'), 
  n = 50, 
  boundary.attr = 'hd', 
  min.thickness = 5
)

s <- trunc(s, 0, 150)

# looks like a cake
par(mar=c(0,0,0,0), fg=NA)
plotSPC(s, print.id = FALSE, name = NA, divide.hz = FALSE, plot.depth.axis = FALSE, width=0.55, x.idx.offset = 2)

# another
s <- perturb(
  subset(x, id == 'MUSICK'), 
  n = 50, 
  boundary.attr = 'hd', 
  min.thickness = 5
)

s <- trunc(s, 0, 150)

par(mar=c(0,0,0,0), fg=NA)
plotSPC(s, print.id=FALSE, name=NA, divide.hz = FALSE, plot.depth.axis = FALSE, width=0.55, x.idx.offset = 2)
```


```{r fig.width=12, fig.height=6}
musick <- subset(x, id == 'MUSICK')
musick$hd <- 5

# simulate
s <- perturb(
  musick, 
  id = sprintf("%03d", 1:50),
  boundary.attr = 'hd', 
  min.thickness = 5
)

s <- trunc(s, 0, 150)

hzn.id <- hzdesgnname(s)
hzn <- hzDesgn(s[1, ])
s$genhz <- generalize.hz(s[[hzn.id]], new = hzn, pat = hzn)

d <- profile_compare(s, vars = c('genhz', 'genhz'), max_d = 150, k = 0)
new.order <- as.hclust(diana(d))$order

# looks like a cake
par(mar=c(0,0,0,0), fg=NA)
plotSPC(s, print.id = FALSE, name = NA, divide.hz = FALSE, plot.depth.axis = FALSE, width=0.55, x.idx.offset = 2, plot.order = new.order)

```


Use simulation to demonstration pair-wise distances between profiles. A "spike" is added so that relative distance can be interpreted.
```{r fig.width=12, fig.height=6}
# example data
data(sp4)
depths(sp4) <- id ~ top + bottom

# simulated based on profile 1
p.idx <- 1

# use profile 6 as a "spike"
spike.idx <- 6

# simulate 
horizons(sp4)$bdy <- 4
set.seed(1010101)
p <- perturb(sp4[p.idx, ], n = 10, boundary.attr = 'bdy', min.thickness = 2)

# remove the old profile ID column
site(p)$id <- NULL

# combine: simulations + original + spike
z <- combine(
    p, 
    sp4[p.idx, ],
    sp4[spike.idx, ]
)

par(mar = c(0,0,3,0))
plotSPC(z, color = 'K', width = 0.3, name.style = 'center-center', plot.depth.axis = FALSE, hz.depths = TRUE, cex.names = 0.65, col.label = 'Exchangeable K')
```

```{r fig.width=12, fig.height=8}

d <- profile_compare(z, vars = c('K', 'sand'), max_d = 40, k = 0)
dd <- diana(d)

plotProfileDendrogram(z, dd, scaling.factor = 1.5, y.offset = 5, color = 'K', width = 0.3, name.style = 'center-center', plot.depth.axis = FALSE, hz.depths = TRUE, cex.names = 0.65, col.label = 'Exchangeable K')

```




----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")`.


