---
title: "Some Ideas on Soil Color Signatures"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
    keep_md: no
---

```{r setup, echo=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE, cache = FALSE)
options(width=100, stringsAsFactors=FALSE, cache=FALSE)
```

# Note
All of these functions will be simplified / documented in the near future, stay tuned.

# Introduction
Pending.

## TODO

 * integrate ideas from [colordistance package](https://cran.r-project.org/web/packages/colordistance/vignettes/colordistance-introduction.html)
 * what is appropriate rescaling of L?
 * use $\Delta E_{00}$ metric color distances via [farver package](https://github.com/thomasp85/farver)

# Examples
Source colors are in sRGB (D65) colorspace, as converted from Munsell notation using `aqp::munsell2rgb()`.

## Basic Idea
Trivial example using some of the `aqp` built-in data, not very interesting.
```{r fig.width=8, fig.height=6}
library(aqp)
library(plyr)
library(cluster)
library(ape)
library(colorspace)
library(soilDB)
library(sharpshootR)


data(sp1)
sp1$soil_color <- with(sp1, munsell2rgb(hue, value, chroma))
depths(sp1) <- id ~ top + bottom
plot(sp1)

# manually convert Munsell -> RGB
rgb.data <- munsell2rgb(sp1$hue, sp1$value, sp1$chroma, return_triplets = TRUE)
sp1$r <- rgb.data$r
sp1$g <- rgb.data$g
sp1$b <- rgb.data$b

pig <- soilColorSignature(sp1)
knitr::kable(pig, digits = 3, row.names = FALSE)
```

Plot results as dendrogram.
```{r fig.width=8, fig.height=6}
row.names(pig) <- pig[, 1]
d <- daisy(pig[, 2:6])
dd <- diana(d)

plotProfileDendrogram(sp1, dd, dend.y.scale = 0.25, scaling.factor = 0.001, y.offset = 0.02, width=0.15)
```



## Colors from Official Series Descriptions

```{r fig.width=12, fig.height=6}
s.list <- c('amador', 'redding', 'pentz', 'willows', 'pardee', 'yolo', 'hanford', 'cecil', 'sycamore', 'KLAMATH', 'MOGLIA', 'vleck', 'drummer', 'CANEYHEAD', 'musick', 'sierra', 'HAYNER', 'zook', 'argonaut', 'PALAU')

# get these soil series
s <- fetchOSD(s.list)

# manually convert Munsell -> sRGB
rgb.data <- munsell2rgb(s$hue, s$value, s$chroma, return_triplets = TRUE)
s$r <- rgb.data$r
s$g <- rgb.data$g
s$b <- rgb.data$b

# check
par(mar=c(1,1,1,1))
plot(s)
```


Look at full range of OSD colors in this set.

Colors, arranged by $\Delta E_{00}$.
```{r fig.width=7, fig.height=7}
previewColors(s$soil_color)
```

```{r fig.width=7, fig.height=7}
rgb.colors <- munsell2rgb(s$hue, s$value, s$chroma, return_triplets = TRUE)
lab.colors <- as(RGB(rgb.colors[['r']], rgb.colors[['g']], rgb.colors[['b']]), 'LAB')@coords
cols <- cbind(rgb.colors, lab.colors)
cols <- na.omit(cols)
cols <- as.data.frame(cols)
pairs(~ L + A + B, data=cols, pch=16, cex=2, col=rgb(cols$r, cols$g, cols$b))
```

### Soil Color Signature by "Pigment Proportions"
Compute proportions of white, red, green, yellow, and blue "pigments" based on the CIE LAB representation of soil colors distributed over horizons, weighted by horizon thickness. Pigment proportions are used so that shallow soils can be compared with deep soils. Each row is an observation, columns describe the multivariate soil color signature. 

```{r fig.width=12, fig.height=6}

## colorBucket method
# what is appropriate rescaling of L?
pig <- soilColorSignature(s, RescaleLightnessBy = 5, method = 'colorBucket')

knitr::kable(head(pig), digits = 3, row.names = FALSE)

# move row names over for distance matrix
row.names(pig) <- pig[, 1]
d <- daisy(pig[, -1])
dd <- diana(d)


par(mar=c(0,0,1,1))
plotProfileDendrogram(s, dd, dend.y.scale = max(d) * 2, scaling.factor = max(d) / max(s), y.offset = max(d) / 10, width=0.25, cex.names=0.45)
```


### Soil Color Signature by "Depth Slices"
Extract CIE LAB coordinates at the 10th, 50th, and 90th percentiles of horizon mid-points. Each row is an observation, columns describe the multivariate soil color signature.
```{r fig.width=12, fig.height=6}
pig <- soilColorSignature(s, RescaleLightnessBy = 5, method='depthSlices')

knitr::kable(head(pig), digits = 3, row.names = FALSE)

# move row names over for distance matrix
row.names(pig) <- pig[, 1]
d <- daisy(pig[, -1])
dd <- diana(d)


par(mar=c(0,0,1,1))
plotProfileDendrogram(s, dd, dend.y.scale = max(d) * 2, scaling.factor = 0.25, y.offset = 6, width=0.25, cex.names=0.45)
```



## Soil Color Signature by "PAM"
Select *k*-medoids (partitioning around medoids algorithm) from all possible colors within the profile or depth interval and use those CIE LAB coordinates as the signature. Each row is an observation, columns describe the multivariate soil color signature.
```{r fig.width=12, fig.height=6}
pig <- soilColorSignature(s, RescaleLightnessBy = 5, method = 'pam', pam.k = 3)

knitr::kable(head(pig), digits = 3, row.names = FALSE)

# move row names over for distance matrix
row.names(pig) <- pig[, 1]
d <- daisy(pig[, -1])
dd <- diana(d)

par(mar=c(0,0,1,1))
plotProfileDendrogram(s, dd, dend.y.scale = max(d) * 2, scaling.factor = 0.25, y.offset = 6, width=0.25, cex.names=0.45)
```


## Soil Color Signature by "PAM" and delta-E00
Select *k*-medoids (partitioning around medoids algorithm) from all possible colors within the profile or depth interval and use those CIE LAB coordinates as the signature. Each row is an observation, columns describe the multivariate soil color signature. Distances are computed via delta-E (CIE2000), $\Delta E_{00}$ within each cluster and summed.
```{r fig.width=12, fig.height=6}
k <- 4
pig <- soilColorSignature(s, RescaleLightnessBy = 5, method = 'pam', pam.k = k)

# iterate over clusters, result is a distance matrix (delta-E00)
delta.E00 <- lapply(1:k, function(i) {
  # LAB coordinates are named by cluster 1:k
  v.names <- paste(c('L', 'A', 'B'), i, sep = '.')
  # delta-E00
  d.i <- farver::compare_colour(pig[, v.names], from_space='lab', white_from = 'D65', method='cie2000')
  # copy over SPC ids
  dimnames(d.i) <- list(pig[, 1], pig[, 1])
  # convert to dist object
  d.i <- as.dist(t(d.i))
  return(d.i)
})

# sum distance matrices
d <- Reduce('+', delta.E00)
# divisive clustering
dd <- diana(d)

par(mar=c(0,0,1,1))
plotProfileDendrogram(s, dd, dend.y.scale = max(d) * 2, scaling.factor = 0.45, y.offset = 6, width=0.25, cex.names=0.45)
```



## Soil Color Art

```{r fig.width=12, fig.height=6}
library(aqp)
library(soilDB)
library(sharpshootR)
library(cluster)

# photogenic soil series
s.list <- c('amador', 'redding', 'pentz', 'willows', 'pardee', 'yolo', 'hanford', 'cecil', 'sycamore', 'KLAMATH', 'MOGLIA',  'vleck', 'drummer', 'CANEYHEAD', 'musick', 'sierra', 'HAYNER', 'zook', 'argonaut', 'PALAU')

# get these soil series
s <- fetchOSD(s.list)

# manually convert Munsell -> sRGB
rgb.data <- munsell2rgb(s$hue, s$value, s$chroma, return_triplets = TRUE)
s$r <- rgb.data$r
s$g <- rgb.data$g
s$b <- rgb.data$b

# generate color signature
pig <- soilColorSignature(s, RescaleLightnessBy = 5, method = 'pam', pam.k = 3)

# propagate IDs
# this will be abstracted in the near future
row.names(pig) <- pig[, 1]

# distance matrix no standardization needed
d <- daisy(pig[, -1], )

# divisive hierarchical clustering
dd <- diana(d)

# adjust margins and default colors
par(mar=c(0,0,0,0), bg='black', fg='white')

# hang profiles from dendrogram
# note customization via arguments passed to plotSPC
plotProfileDendrogram(s, dd, dend.y.scale = max(d) * 2, scaling.factor = 0.3, y.offset = 1, width=0.35, cex.names=0.45, name=NA, dend.color = 'white', dend.width = 2, divide.hz=FALSE, print.id=FALSE, plot.depth.axis=FALSE)
```


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")`.

