---
title: "Investigating Soil Series Extent"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    jquery: null
    mathjax: null
    smart: no
---

```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
# library(printr, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=1, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```


# Introduction
This document demonstrates how to use the [soilDB](http://ncss-tech.github.io/AQP/soilDB/soilDB-Intro.html) package to access detailed soil series extent maps via SoilWeb. These maps can be directly displayed in **R**, overlayed on Google Maps, or saved as local files (e.g. shapefiles). Data returned from SoilWeb represent bounding-boxes that enclose SSURGO polygons associated with map units containing the search criteria. Bounding-boxes are snapped to 0.01 degree precision in order to reduce processing time and file size. Note that these files are cached server-side after the first request, and the cache is purged when SoilWeb is periodically synced to the official data.

# Installation
With a recent version of R, it should be possible to get all of the packages that this tutorial depends on via:
```{r install-deps, eval=FALSE}
# run these commands in the R console to install required packages
install.packages('soilDB', dep=TRUE)
install.packages('RColorBrewer', dep=TRUE)
install.packages('sf', dep=TRUE)
install.packages('maps', dep=TRUE)
install.packages('scales', dep=TRUE)
install.packages('mapview', dep=TRUE)
```

# Examples 
Illustrate the extent of SSURGO map units associated with the Amador series.
```{r results='hide'}
# load required libraries
library(soilDB)
library(raster)
library(sp)
library(sf)
library(rgdal)
library(maps)
library(RColorBrewer)
```


Investigate the structure of soil series extent data.
```{r }
# the result is a SpatialPolygonsDataFrame object
amador <- seriesExtent('amador')

# internal structure / class
str(amador, 2)

# coordinate reference system in PROJ4 notation
proj4string(amador)

# check attribute table, details: http://casoilresource.lawr.ucdavis.edu/see/
slot(amador, 'data')
```

## Compare Amador, Pardee, and San Joaquin Extents
```{r results='hide'}
# soil series of interest
s <- c('amador', 'pardee', 'san joaquin')

# define some nice colors
cols <- brewer.pal('Set1', n = length(s))

# iterate over vector of soil series names
# and store spatial extents in a list
s.extent <- lapply(s, seriesExtent, timeout=120)

# combine into a single SpatialPolygonsDataFrame
s.extent <- do.call('rbind', s.extent)

# convert into an sf object
s.extent <- st_as_sf(s.extent)

# very simple plot method for sf objects
# https://r-spatial.github.io/sf/articles/sf5.html
plot(s.extent['series'], axes = FALSE, key.width = lcm(4.5), pal = cols)
```


## Interactive mapping from R
This is based on the [mapview](https://r-spatial.github.io/mapview/) package.
```{r}
library(mapview)
mapview(s.extent, zcol = 'series', legend = TRUE)
```

## Exporting Series Extent Data
Save soil series extent data in multiple formats.
```{r example-4, eval=FALSE}
# save using the coordinate reference system associated with this object (GCS WGS84)
write_sf(s.extent, dsn='amador-pardee-san-joaquin-extent.shp')

# save as KML for use in Google Earth
# writeOGR(s.extent, dsn='amador-pardee-san-joaquin-extent.kml', layer='amador-pardee-san-joaquin', driver='KML')

# project to UTM zone 10 NAD83 and save
# s.extent.utm <- spTransform(s.extent, CRS('+proj=utm +zone=10 +datum=NAD83'))
# writeOGR(s.extent.utm, dsn='.', layer='amador-pardee-san-joaquin-extent-utm', driver='ESRI Shapefile')
```


# Graphical Display of Joint Series Extent

Using vector features, works with all SSURGO data.
```{r, results = 'hide'}
library(scales) # need this for alpha()

# define some nice colors
cols <- brewer.pal('Set1', n=3)

# list of series for investigation of joint occurrence
s <- c('pentz', 'peters', 'pardee', 'amador', 'san joaquin', 'redding', 'auburn')

# get list of extents
e <- lapply(s, seriesExtent)

# convert to sf objects
e <- lapply(e, st_as_sf) 

# flatten to single sf object
e <- do.call('rbind', e)

# map of CA
par(mar=c(1,1,1,1))
map('state', 'ca')

# sf plot method
# polygon extents are "stacked" with transparency
plot(st_geometry(e), border = NA, col = alpha(cols[2], 0.25), add = TRUE)

# finish map
box()
title(main='Joint Occurrence', line=1.25)
mtext(side=1, text=as.character(Sys.Date()), line=0)
```



```{r, results='hide'}
library(rasterVis)
library(viridis)

# using all siblings of a given soil series
s <- 'zook'
sib <- siblings(s)
sib.names <- c(s, sib$sib$sibling)

# get list of series extent grids
# note these all have different bounding-boxes (raster extents)
g <- lapply(sib.names, function(i) {
  se <- suppressWarnings(seriesExtent(i, type = 'raster'))
  # threshold at 15%
  # se <- se >= 15
  
  return(se)
})

# extract the extent / BBOX for each
e <- lapply(g, extent)

# convert to Spatial Polygons
e <- lapply(e, as, 'SpatialPolygons')

# hack: assign each extent an ID so they can be merged
for(i in 1:length(e)) {
  e[[i]] <- spChFIDs(e[[i]], as.character(i))
}

# combine list of SP into single, multi-feature SP object
p <- do.call('rbind', e)

# graphical check, ok
plot(p)

# extend each series extent grid to the full extent / BBOX
ge <- lapply(g, function(i) {
  extend(i, extent(p))
})

# grids are conformal
# convert to rasterStack for convenience
# each layer has been thresholded to binary 0/1 raster
ge <- stack(ge)

# sum pixels across raster stack
x <- stackApply(ge, indices = rep(1, times = nlayers(ge)), fun = sum, na.rm = TRUE)

# set 0 to nodata
x[x == 0] <- NA

x <- x / maxValue(x)

levelplot(
  x,
  col.regions=viridis,
  main = 'Joint Occurrence',
  margin = FALSE, 
  scales = list(draw = FALSE)
)

# generalize via focal sum
a <- aggregate(x, fact = 5, fun = sum, na.rm = TRUE)

levelplot(
  a,
  col.regions=viridis,
  main = 'Joint Occurrence',
  margin = FALSE, 
  scales = list(draw = FALSE)
)

```


# Boomer Soil Series Extent
Lets investigate the spatial extent and MLRA overlap for the [Boomer](http://casoilresource.lawr.ucdavis.edu/sde/?series=boomer) soil series. We will use the SoilWeb SEE data for an estimate of the spatial extent and [Soil Data Access](http://ncss-tech.github.io/AQP/soilDB/SDA-tutorial.html) for MLRA overlap information.


Get extent and make a simple map.
```{r}
# define some nice colors
cols <- brewer.pal('Set1', n=3)

# get extent
boomer <- seriesExtent('boomer')

# basic figure
par(mar=c(1,0,1,0))
map(database='county', regions='california')
plot(boomer, col=cols[2], border=cols[2], add=TRUE)
box()
title(main='Boomer Series Extent', line=1.25)
mtext(side=1, text=as.character(Sys.Date()), line=0)
```

Investigate MLRA overlap for the Boomer series via [SDA](http://ncss-tech.github.io/AQP/soilDB/SDA-tutorial.html) (official SSURGO data). These results are based on the assumption that the "muaoverlap" table is correctly populated.
```{r}
res <- SDA_query("SELECT compname, areasymbol as mlra, areaname as mlra_name, count(compname) as n_components from laoverlap JOIN muaoverlap ON laoverlap.lareaovkey = muaoverlap.lareaovkey JOIN component ON muaoverlap.mukey = component.mukey WHERE compname = 'boomer' AND areatypename = 'MLRA' GROUP BY compname, areasymbol, areaname ORDER BY count(compname) DESC")
kable(res, row.names = FALSE)
```

That seems strange, which map units are in MLRA 31?
```{r}
res <- SDA_query("SELECT component.mukey, muname, compname, comppct_r from laoverlap JOIN muaoverlap ON laoverlap.lareaovkey = muaoverlap.lareaovkey JOIN mapunit ON muaoverlap.mukey = mapunit.mukey JOIN component ON muaoverlap.mukey = component.mukey WHERE compname = 'boomer' AND areatypename = 'MLRA' AND areasymbol = '31'")
kable(res, row.names = FALSE)
```

Save extent for Boomer series as shapefile (GCS/WGS84).
```{r, eval=FALSE}
writeOGR(boomer, dsn='.', layer='boomer-extent', driver='ESRI Shapefile')
```



----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.
