---
title: "Soil Series Co-Occurrence Data"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
---
  
  
```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
library(kableExtra, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```


TODO: 

   * write definitions
   * demonstrate major/minor siblings
   * extend with joint area calculation


Recreate functionality of previous API.
```{r, fig.width=10}
library(soilDB)
library(sharpshootR)
library(latticeExtra)
library(reshape2)
library(cluster)
library(ape)

# new function as of 2.2-8
# get sibling data for Amador soil series via SoilWeb
# note that sib$sib may contain duplicates, based on major/minor component status
s <- siblings('amador', component.data = TRUE)

str(s)

# convert into adjacency matrix
m <- component.adj.matrix(s$sib.data[s$sib.data$compkind == 'Series', ], mu = 'mukey', co = 'compname', wt = 'comppct_r')

# plot network diagram, with Amador soil highlighted
par(mar=c(0.5,0.5,0.5,0.5))
plotSoilRelationGraph(m, s='Amador', vertex.scaling.factor=2, edge.transparency=0.75, edge.col=grey(0.85), edge.highlight.col='black', vertex.label.family='sans')
```


Sibling type and counts.
```{r}
kable_styling(kable(s$sib, format = 'html'), full_width = FALSE, font_size = 10)
```

Combine counts for major/minor siblings.
```{r eval=FALSE}
plyr::ddply(s$sib, c('series', 'sibling'), .fun=plyr::summarise, n=sum(n))
```

Split sibling lists and get basic morphology from OSDs.
```{r}
idx <- which(s$sib$majcompflag)
major.siblings <- c(s$sib$series[1], s$sib$sibling[idx])
all.siblings <- unique(c(s$sib$series[1], s$sib$sibling))

# get basic OSD data for queried series and siblings
h.major <- fetchOSD(major.siblings)
h.all <- fetchOSD(all.siblings)
```


Siblings that are major components.
```{r fig.width=7}
SoilTaxonomyDendrogram(h.major)
```

All siblings.
```{r fig.width=10}
SoilTaxonomyDendrogram(h.all)
```


Cousin lookup.
```{r eval=FALSE}
# takes a while to run, there will be duplicates in counsins here
s <- siblings('amador', component.data = TRUE, cousins = TRUE)

# combine sibling + cousin data, remove duplicates
d <- unique(rbind(s$sib.data, s$cousin.data))

# subset to components that are correlated to a soil series
d <- d[which(d$compkind == 'Series'), ]

# convert into adjacency matrix
m <- component.adj.matrix(d, mu = 'mukey', co = 'compname', wt = 'comppct_r')

# plot network diagram, with Amador soil highlighted
par(mar=c(1,1,1,1))
plotSoilRelationGraph(m, s='Amador')


# fetch and convert data into an SPC
h <- fetchOSD(c(s$sib$series[1], unique(s$cousins$sibling)))

# plot dendrogram + profiles
SoilTaxonomyDendrogram(h)
```

## Geomorphic Summaries

```{r}
s.all.siblings <- fetchOSD(all.siblings, extended = TRUE)
```

Compare hillslope position.
```{r fig.width=12, fig.height=5, echo=FALSE}
res <- vizHillslopePosition(s.all.siblings$hillpos, s = 'AMADOR')
print(res$fig)
```

Compare geomorphic component.
```{r fig.width=12, fig.height=5, echo=FALSE}
res <- vizGeomorphicComponent(s.all.siblings$geomcomp, s = 'AMADOR')
print(res$fig)
```

## MLRA and Parent Material Summaries
TODO

## Investigate Spatial Patterns
TODO

## KSSL Data
TODO


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")`, `soilDB` version `r utils::packageDescription("soilDB", field="Version")`, and `sharpshootR` version `r utils::packageDescription("sharpshootR", field="Version")`.

