---
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
---
  
```{r setup, echo=FALSE, results='hide', warning=FALSE}
library(knitr, quietly=TRUE)
library(printr, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```

Water Retention Curve Development from KSSL Data
===============================
`r format(Sys.time(), "%Y-%m-%d")`
<br>Dylan Beaudette


## Introduction
This is a simple demonstration of how to use (estimated) van Genuchten Model parameters from the KSSL snapshot (added 2016-11-17) as provided by [`fetchKSSL()`](http://ncss-tech.github.io/AQP/soilDB/KSSL-demo.html) to generate water retention curves. These parameters are based on a model fit using the Rosetta software.


### Setup
With a recent version of R (>= 2.15), it is possible to get all of the packages that this tutorial depends on via:
```{r eval=FALSE}
# run these commands in the R console
install.packages('latticeExtra', dep=TRUE)
install.packages('plyr', dep=TRUE)
install.packages('rvest', dep=TRUE)
install.packages('httr', dep=TRUE)
install.packages('reshape2', dep=TRUE)
install.packages('soilDB', dep=TRUE)
```

You will also need the latest version of `soilDB` and `aqp`:
```{r eval=FALSE}
install.packages('devtools', dep=TRUE)
devtools::install_github("ncss-tech/aqp", dependencies=FALSE, upgrade_dependencies=FALSE)
devtools::install_github("ncss-tech/soilDB", dependencies=FALSE, upgrade_dependencies=FALSE)
```


## Simple Plot of Water Retention Curves

Plot (estimated) water retention curves for all horizons associated with the [Cecil](http://casoilresource.lawr.ucdavis.edu/sde/?series=cecil) soil series.
```{r fig.width=10, fig.height=6}
library(aqp)
library(soilDB)
library(latticeExtra)
library(plyr)

# get KSSL data
s <- fetchKSSL(series = 'cecil')

# subset VG parameters
s.vg.hz <- horizons(s)[, c('labsampnum', 'hzn_desgn', 'hzn_top', 'hzn_bot', 'lab_texture_class', 'theta_r', 'theta_s', 'alpha', 'npar')]
s.vg.hz <- na.omit(s.vg.hz)

# iterate over horizons and generate VG model curve
res <- lapply(1:nrow(s.vg.hz), function(i) {
  m <- KSSL_VG_model(VG_params = s.vg.hz[i, ], phi_min = 10^-3, phi_max=10^6)$VG_curve
  m$hzn_desgn <-s.vg.hz$hzn_desgn[i]
  return(m)
})

# copy over lab sample number as ID
names(res) <- s.vg.hz$labsampnum
res <- ldply(res)

# simple generalization of horizons
res$hz <- generalize.hz(res$hzn_desgn, new=c('A', 'Bt', 'C'), pat=c('A', 'Bt', '^C'))

# plot each curve, panel by genhz
p.model <- xyplot(phi ~ theta | hz, groups=.id, data=res, type=c('l', 'g'), scales=list(alternating=3, x=list(tick.number=10), y=list(log=10, tick.number=10)), yscale.components=yscale.components.logpower, ylab=expression("Suction " (kPa)), xlab=expression("Volumetric Water Content " (cm^3/cm^3)), par.settings = list(superpose.line=list(col='RoyalBlue', lwd=1)), strip=strip.custom(bg=grey(0.85)), as.table=TRUE)

update(p.model, main='Estimated Water Retention Curves', sub='van Genuchten Model Parameters fit by USDA-ARS Rosetta')
```

## Additional Examples
See the [SCAN/SNOTEL](http://ncss-tech.github.io/AQP/soilDB/fetchSCAN-demo.html) tutorial for more ideas.


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.

