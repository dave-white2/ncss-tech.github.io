---
title: "What does a subgroup look like?"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
library(kableExtra, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```

# Introduction

[Soil Taxonomy](https://www.nrcs.usda.gov/wps/portal/nrcs/main/soils/survey/class/taxonomy/) is a theoretical framework for organizing soil information, typically at scales coarser than most land management decisions. Soil series are a practical (but limited in geographic scope) framework for organizing soil/landscape combinations close to the scale of land management decisions.

So, what is the practical manifestation of a single subgroup from Soil Taxonomy (*abruptic durixeralfs*), in terms of soil series concepts?

The following code, links, and notes may serve as a starting point for those interested in learning more about Soil Taxonomy. This is a work in progress.
```{r}
# AQP suite, be sure to use the development versions from GitHub
library(aqp)
library(soilDB)
library(sharpshootR)

# used for visualization
library(latticeExtra)
library(tactile)
library(cluster)
library(ape)
library(FactoMineR)

# mapping a subgroup
library(sp)
library(sf)
library(raster)
library(spData) 
library(rasterVis)
library(viridis)

# subgroup "explainer"
library(SoilTaxonomy)
```


# Examples
Get a snapshot of the Soil Classification database. This contains the current classification for all soil series.
```{r}
# latest version, synced quarterly
u <- 'https://github.com/ncss-tech/SoilWeb-data/raw/main/files/SC-database.csv.gz'
tf <- tempfile()
download.file(u, destfile = tf)
SC <- read.csv(tf, stringsAsFactors = FALSE)
```

Identify all of the soil series associated with a specific subgroup taxa: *abruptic durixeralfs* and download basic morphology and climate summaries via `fetchOSD`.
```{r}
# select series names for a single subgroup
s <- SC$soilseriesname[which(SC$taxsubgrp == 'abruptic durixeralfs')]

# get OSD morphology and extended summaries
osd <- fetchOSD(soils = s, extended = TRUE)
```

## ST Explainer
Explain subgroup taxa via [SoilTaxonomy](https://github.com/ncss-tech/SoilTaxonomy/tree/master/R_pkg) package.
```{r eval=FALSE}
cat(explainST('abruptic durixeralfs'))
```

<pre>
```{r results='asis', echo=FALSE}
cat(explainST('abruptic durixeralfs'))
```
</pre>


## SoilWeb seriesTree Application
![seriesTree figure](resources/seriesTree-example.png)
Link to SoilWeb subgroup taxa tree for [abruptic durixeralfs](https://casoilresource.lawr.ucdavis.edu/seriesTree/?subgroup=abruptic%20durixeralfs).


## Taxa Extent Maps

```{r fig.height = 8, fig.width = 5.5}
# get 800m extent map
e <- taxaExtent('abruptic durixeralfs', level = 'subgroup')

# aggregate via focal mean using 5x5 moving window
# visualization purposes only
a <- raster::aggregate(e, fact = 5)

data("us_states")
us_states <- as(us_states, 'Spatial')
us_states <- spTransform(us_states, CRS(projection(e)))
us_states <- crop(us_states, e)

# simple figure
levelplot(
  a, 
  margin = FALSE, 
  scales = list(draw = FALSE), 
  col.regions = viridis, 
  main = names(a),
  sub = 'pixel values represent percent ofarea\nwithin 800m grid cells',
  panel=function(...) {
            panel.levelplot(...)
            sp.polygons(us_states, col='black', lwd=2)
          }
)
```


## Data via soilDB::fetchOSD
Cluster series based on annual climate summaries but don't plot it yet.
```{r}
# control centers symbol and size here
res <- vizAnnualClimate(osd$climate.annual, s='SAN JOAQUIN', IQR.cex = 1.1, cex=1.1, pch=18)
```

Series associated with **abruptic durixeralfs** subgroup, arranged according to annual climate summaries.
```{r fig.width=14, fig.height=6}
par(mar=c(0,0,1,1))
plotProfileDendrogram(osd$SPC, clust = res$clust, scaling.factor = 0.075, width = 0.25, y.offset = 0.5)
mtext('Abruptic Durixeralfs', side = 1, at = 0.5, adj = 0, line = -1.5, font=4)
mtext('sorted by annual climate summaries', side = 3, at = 0.5, adj = 0, line = -1.5, font=3)
```

### Annual climate summaries
```{r fig.width=12, fig.height=8}
# display annual climate summary
trellis.par.set(plot.line=list(col='RoyalBlue'))
print(update(res$fig, layout=c(4,2), sub='Abruptic Durixeralfs'))
```


### Geomorphic Descriptions
```{r fig.height=5, fig.width=8.5}
hs <- vizHillslopePosition(osd$hillpos)
print(hs$fig)

gc <- vizGeomorphicComponent(osd$geomcomp)
print(gc$fig)

tr <- vizTerracePosition(osd$terrace)
print(tr$fig)
```

```{r fig.height=6.5, fig.width=6.5}
hs.tab <- (osd$hillpos[, 2:6])
row.names(hs.tab) <- osd$hillpos$series

gc.tab <- (osd$geomcomp[, 2:7])
row.names(gc.tab) <- osd$geomcomp$series

hs.ca <- CA(hs.tab, graph = FALSE)
gc.ca <- CA(gc.tab, graph = FALSE)


plot(hs.ca, autoLab='yes', title='Hillslope Position', cex=0.75, col.col='firebrick', col.row='royalblue')
plot(gc.ca, autoLab='yes', title='Geomorphic Component', cex=0.75, col.col='firebrick', col.row='royalblue')
```


## KSSL Data
```{r fig.width=8, fig.height=5.5, results='hide'}
# TODO: use SDA to get all that are available
# TODO: L1 profile

# this will miss all records that have been correlated to the subgroup but not series
lab <- fetchKSSL(series = s, returnMorphologicData = TRUE, simplifyColors = TRUE)
lab.spc <- lab$SPC 

lab.spc$wmpd <- with(horizons(lab.spc), ((vcs * 1.5) + (cs * 0.75) + (ms * 0.375) + (fs * 0.175) + (vfs *0.075) + (silt * 0.026) + (clay * 0.0015)) / (vcs + cs + ms + fs + vfs + silt + clay))

# estimate soil depth based on horizon designations
sdc <- getSoilDepthClass(lab.spc)

# splice-into site data
site(lab.spc) <- sdc


site(lab.spc)$.grp <- factor('Abruptic Durixeralfs')
a <- slab(lab.spc, .grp ~ clay + sand + wmpd + estimated_ph_h2o + bs82)

# define plotting style
tps <- tactile.theme(superpose.line=list(col=c('RoyalBlue', 'DarkRed', 'DarkGreen'), lwd=2))

# plot grouped, aggregate data
xyplot(top ~ p.q50 | variable, 
       groups = .grp, 
       data = a, 
       ylab='Depth',
       xlab='median bounded by 25th and 75th percentiles',
       main = 'Abruptic Durixeralfs',
       lower=a$p.q25, upper=a$p.q75, ylim=c(155,-5),
       panel=panel.depth_function, alpha=0.25, sync.colors=TRUE,
       prepanel=prepanel.depth_function,
       cf=a$contributing_fraction,
       par.strip.text=list(cex=0.8),
       strip=strip.custom(bg=grey(0.85)),
       layout=c(5,1), 
       scales=list(x=list(alternating=1, relation='free'), y=list(alternating=3)),
       par.settings=tps
)
```

### Morphologic Summaries
by heneralized horizon labels, depth intervals, ???.

### ST Criteria via {aqp}
```{r, eval = FALSE}
hasDarkColors(lab.spc, dhuenm = 'd_hue', dvalnm = 'd_value', dchrnm = 'd_chroma', mhuenm = 'm_hue', mvalnm = 'm_value', mchrnm = 'm_chroma')

profileApply(lab.spc, getArgillicBounds, clay.attr = 'clay', texcl.attr = 'lab_texture_class', simplify = FALSE)
```


## SoilWeb metadata
```{r}
kable_styling(kable(osd$soilweb.metadata, format = 'html', caption = 'SoilWeb Snapshot Metadata'), full_width = FALSE, font_size = 10)
```


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.

