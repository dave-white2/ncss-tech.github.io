---
title: "What does a subgroup look like?"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
  mathjax: null
jquery: null
smart: no
---

```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
library(kableExtra, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```

[Soil Taxonomy](https://www.nrcs.usda.gov/wps/portal/nrcs/main/soils/survey/class/taxonomy/) is a theoretical framework for organizing soil information, typically at scales coarser than most land management decisions. Soil series are a practical (but limited in geographic scope) framework for organizing soil/landscape combinations close to the scale of land management decisions.

So, what is the practical manifestiation of a single subgroup from Soil Taxonomy (*abruptic durixeralfs*), in terms of soil series concepts?

The following code, links, and notes may serve as a starting point for those interested in learning more about Soil Taxonomy. This is a work in progress.
```{r}
# AQP suite, be sure to use the development versions from GitHub
library(aqp)
library(soilDB)
library(sharpshootR)

# used for visualization
library(latticeExtra)
library(cluster)
library(ape)

# subgroup explainer
library(SoilTaxonomy)
```

Get a snapshot of the Soil Classification database. This contains the current classification for all soil series.
```{r}
tf <- tempfile()
download.file('https://github.com/ncss-tech/SoilTaxonomy/raw/master/databases/SC-database.csv.gz', destfile = tf)
SC <- read.csv(gzfile(tf), stringsAsFactors = FALSE)
```

Identify all of the soil series associated with a specific subgroup taxa: *abruptic durixeralfs* and download basic morphology and climate summaries via `fetchOSD`.
```{r}
# select series names for a single subgroup
s <- SC$soilseriesname[which(SC$tax_subgrp == 'abruptic durixeralfs')]

# get OSD morphology and extended summaries
osd <- fetchOSD(soils=s, extended = TRUE)
```


Explain subgroup taxa via [SoilTaxonomy](https://github.com/ncss-tech/SoilTaxonomy/tree/master/R_pkg) package.
```{r eval=FALSE}
cat(explainST('abruptic durixeralfs'))
```

<pre>
```{r results='asis', echo=FALSE}
cat(explainST('abruptic durixeralfs'))
```
</pre>

Link to SoilWeb subgroup taxa tree for [abruptic durixeralfs](https://casoilresource.lawr.ucdavis.edu/seriesTree/?subgroup=abruptic%20durixeralfs).


Cluster series based on annual climate summaries but don't plot it yet.
```{r}
# control centers symbol and size here
res <- vizAnnualClimate(osd$climate.annual, s='SAN JOAQUIN', IQR.cex = 1.1, cex=1.1, pch=18)
```

Series associated with **abruptic durixeralfs** subgroup, arranged according to annual climate summaries.
```{r fig.width=14, fig.height=6}
par(mar=c(0,0,1,1))
plotProfileDendrogram(osd$SPC, clust = res$clust, scaling.factor = 0.075, width = 0.2, y.offset = 0.5)
mtext('Abruptic Durixeralfs', side = 1, at = 0.5, adj = 0, line = -1.5, font=4)
mtext('sorted by annual climate summaries', side = 3, at = 0.5, adj = 0, line = -1.5, font=3)
```

Annual climate summaries
```{r fig.width=12, fig.height=8}
# display annual climate summary
trellis.par.set(plot.line=list(col='RoyalBlue'))
print(update(res$fig, layout=c(4,2), sub='Abruptic Durixeralfs'))
```


Review SoilWeb metadata
```{r}
kable_styling(kable(osd$soilweb.metadata, format = 'html', caption = 'SoilWeb Snapshot Metadata'), full_width = FALSE, font_size = 10)
```


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.



```{r echo=FALSE}
# library(scales)
# library(raster)
# library(sp)

# # define some nice colors
# cols <- brewer.pal('Set1', n=3)
# 
# # get list of extents
# l <- lapply(s, seriesExtent)
# 
# # get full extent
# e <- lapply(lapply(l, raster::extent), as, 'SpatialPolygons')
# 
# # give each extent a unique ID
# # required for rbind
# for(i in seq_along(e)) {
#   e[[i]] <- spChFIDs(e[[i]], as.character(i))
#   }
# 
# # combine
# e <- do.call('rbind', e)
# 
# # get combined extent
# e <- as.vector(extent(e))
# 
# # map of CONUS
# par(mar=c(1 ,1,1,1))
# maps::map('state')
# 
# # rough estimation of joint density via transparency  / overlay
# lapply(l, function(i) {
#   plot(i, border=NA, col=alpha(cols[2], 0.85), add=TRUE)
# })
# 
# # finish map
# box()
# title(main='Abruptic Durixeralfs', line=1.25)
# 
# 
```


