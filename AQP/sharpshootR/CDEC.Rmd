---
title: "CDEC: CA Climate Data"
author: "D.E. Beaudette"
date: "`r Sys.Date()`"
output:
  html_document:
  mathjax: null
jquery: null
smart: no
keep_md: no
---
  
```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
library(kableExtra, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE, cache=TRUE)
```


# Background

The [California Data Exchange Center (CDEC)](https://cdec.water.ca.gov/) hosts all kinds of useful climate data. You can get these easily by station and sensor code with the `CDECquery()` function. Lookup sensor codes by station with the `CDEC_StationInfo()` function.

Find CDEC stations via:

   * [map](http://cdec.water.ca.gov/cdecstation2/)
   * [search](http://cdec.water.ca.gov/cgi-progs/staSearch)
   * [station ID](http://cdec.water.ca.gov/dynamicapp/staMeta)
   * [other](http://cdec.water.ca.gov/staInfo.html)


List of sensor codes [by ID](http://cdec.water.ca.gov/misc/senslist.html) and associated units of measure.



# Examples


## Setup R Environment
With a recent version of R (>= 2.15), it is possible to get all of the packages that this tutorial depends on via:
```{r install-deps, eval=FALSE}
# run these commands in the R console
install.packages('sharpshootR', dep=TRUE)
install.packages('soilDB', dep=TRUE)
install.packages('plyr', dep=TRUE)
install.packages('seas', dep=TRUE)
install.packages('viridis', dep=TRUE)
install.packages('latticeExtra', dep=TRUE)
install.packages('RColorBrewer', dep=TRUE)
install.packages('zoo', dep=TRUE)

# get latest version from GitHub
install.packages('devtools', dep=TRUE)
devtools::install_github("ncss-tech/sharpshootR", dependencies=FALSE, upgrade_dependencies=FALSE)
```


Load required packages.
```{r}
library(latticeExtra)
library(plyr)
library(sharpshootR)
library(viridis)
library(seas)
library(RColorBrewer)
library(zoo)
```

## Basic Usage

Get the sensor list for the [SPW](http://cdec.water.ca.gov/dynamicapp/staMeta?station_id=SPW) station.
```{r }
res <- CDEC_StationInfo('SPW')
kable_styling(kable(res, format = 'html'), font_size = 10)
```


Get daily precipitation (sensor = **45**, interval = **'D'**) for a specified time interval.
```{r}
res <- CDECquery(id='SPW', sensor=45, interval='D', start='2018-01-01', end='2018-01-31')

# first 10 rows
kable_styling(kable(head(res, 10), format = 'html'), font_size = 10)
```


## Soil Temperature and Moisture
Some of the CDEC stations have below-ground sensors. The [Highland Meadow](http://cdec.water.ca.gov/dynamicapp/staMeta?station_id=HHM) station was the first one to have soil sensors installed at three depths. These data are collected every 20 minutes.

```{r results='hide', fig.width=12, fig.height=8}
# define station
stn <- 'HHM'
# get station / sensor information
stn.info <- CDEC_StationInfo(stn)

# find sensor IDs for soil temperature and moisture
soil.temp.sensors <- stn.info$sensor[grep('soil temp', stn.info$sensor_details, ignore.case = TRUE)]
soil.moist.sensors <- stn.info$sensor[grep('soil moistr', stn.info$sensor_details, ignore.case = TRUE)]


# iterate over soil temperature sensor codes and download data
# result is a data.frame
d.soil_temp <- ldply(soil.temp.sensors, .progress = 'text', .fun=function(i) {
  x <- CDECquery(stn, i, 'E', '2017-01-01', '2017-12-31')
  x$id <- stn.info$sensor_details[which(stn.info$sensor == i)]
  return(x)
})


# remove soil temperature less than 20 deg F
d.soil_temp <- subset(d.soil_temp, subset=value > 20)


# iterate over soil moisture sensor codes and download data
# result is a data.frame
d.soil_moist <- ldply(soil.moist.sensors, .progress = 'text', .fun=function(i) {
  x <- CDECquery(stn, i, 'E', '2017-01-01', '2017-12-31')
  x$id <- stn.info$sensor_details[which(stn.info$sensor == i)]
  # smooth with rolling median
  x$value <- rollmedian(x$value, k=5, fill = TRUE)
  return(x)
})

# remove soil moisture (VWC) < 5%
d.soil_moist <- subset(d.soil_moist, subset=value > 5)

# combine for plotting
d <- make.groups('Soil Temperature (F)'=d.soil_temp, 'Soil Volumetric Water Content (%)'=d.soil_moist)

# plot colors and line widths
tps <- list(superpose.line=list(col=brewer.pal(3, 'Set1'), lwd=1.5))

xyplot(value ~ datetime | which, groups=id, data=d, type=c('g', 'l'), auto.key=list(cex=0.5, columns=2, points=FALSE, lines=TRUE), strip=strip.custom(bg=grey(0.90)), par.settings=tps, layout=c(1,2), scales=list(alternating=3, x=list(format="%b\n%Y"), y=list(relation='free')), xlab='', ylab='', sub='HHM')
```



## Precipitation

### Daily Precipitation for Current Water Year
```{r}
x <- CDECquery(id='sor', sensor=45, interval='D', start='2017-07-01', end='2019-01-01')

# replace NA with 0 in cumulative calc
x$cumulative <- cumsum(ifelse(is.na(x$value), 0, x$value))

plot(value ~ datetime, data=x, type='h')
plot(cumulative ~ datetime, data=x, type='S')
sum(x$value, na.rm = TRUE)
```

### Monthly Precipitation
```{r}
x <- CDECquery(id='sor', sensor=2, interval='M', start='1900-01-01', end='2019-01-01')

# plot
bwplot( month ~ value, data=x, xlab='', ylab='', main='Sonora Ranger Station\nMonthly Total Precipitation (inches)')
```


### Visualization Ideas
Query the entire record of daily precipitation measurements from New Hogan Lake ([NHG](http://cdec.water.ca.gov/cgi-progs/staMeta?station_id=NHG)).
```{r}
# stations are specified with 3-letter codes
x <- CDECquery(id='NHG', sensor=45, interval='D', start='1900-01-01', end='2019-01-01')
summary(x$value)
head(x)
nrow(x)
```

Plot raw data that are great than 0 inches.
```{r, fig.width=8, fig.height=4}
x <- subset(x, value >= 0)
xyplot(value ~ datetime, data=x, type='l', main='NEW HOGAN LAKE (NHG)', ylab='Daily Precipitation (inches)', xlab='')
```

Sum daily precipitation by year/month and display as box-whisker plot.
```{r, fig.width=8, fig.height=4.5}
a <- ddply(x, c('year','month'), plyr::summarise, ppt=sum(value, na.rm=TRUE))

# plot
bwplot(ppt ~ month, data=a, xlab='', ylab='Monthly Total Precipitation (inches)', main='NEW HOGAN LAKE (NHG)', scales=list(y=list(tick.number=10), x=list(cex=0.85, rot=45)))
```

Visualize monthly precipitation as grouped by year/month.
```{r, fig.width=12, fig.height=5}
# color ramp for monthly PPT
cols <- colorRampPalette(rev(viridis(10)), space='Lab', interpolate='spline')

levelplot(ppt ~ factor(year) * month, data=a, col.regions=cols, xlab='', 
          ylab='', scales=list(x=list(tick.number=10, rot=45)), 
          main='NEW HOGAN LAKE (NHG)\nMonthly Total Precipitation (inches)')
```


Alternate representation via `seas` package.
```{r, fig.width=11, fig.height=5}
# alter column names and convert units from in to mm
names(x)[1] <- 'date'
x$value <- x$value * 25.4
x$precip <- x$value

# init seas object
ss <- seas.sum(x, 'precip', width='month', start.day = as.Date('2015-09-01'), prime='precip')

# monthly summaries, arranged according to CA water year
plot(ss, main='NEW HOGAN LAKE (NHG)')
```

Alternate representation
```{r, fig.width=10, fig.height=10}
image(ss)
```

Monthly normals.
```{r, fig.width=11, fig.height=5}
sn <- seas.norm(ss)
plot(sn)
```




## Reservoir Levels
```{r, fig.width=11, fig.height=5}
# get daily resevoir storage (ac. ft) from Pinecrest, New Melones, Lyons, and Don Pedro Reservoirs
pinecrest <- CDECquery(id='swb', sensor=15, interval='D', start='2015-01-01', end='2019-01-01')
new.melones <- CDECquery(id='nml', sensor=15, interval='D', start='2015-01-01', end='2019-01-01')
lyons <- CDECquery(id='lys', sensor=15, interval='D', start='2015-01-01', end='2019-01-01')
dp <- CDECquery(id='dnp', sensor=15, interval='D', start='2015-01-01', end='2019-01-01')

# compute storage capacity, based on published capacities
pinecrest$capacity <- pinecrest$value / 18312 * 100
new.melones$capacity <- new.melones$value / 2400000 * 100
lyons$capacity <- lyons$value / 6228 * 100
dp$capacity <- dp$value / 	2030000 * 100

# combine
g <- make.groups('New Melones'=new.melones, 'Lyons'=lyons, 'Pinecrest'=pinecrest, 'Don Pedro'=dp)

# resonable date scale
r <- range(g$datetime)
s.r <- seq(from=r[1], to=r[2] + 6000000, by='6 months')

# better colors
tps <- list(superpose.line=list(lwd=2, col=brewer.pal(n=4, name='Set1')))

# plot
xyplot(capacity ~ datetime, groups=which, data=g, type='l', 
       xlab='', ylab='Capacity (%)',
       scales=list(alternating=3, y=list(tick.number=10),x=list(at=s.r, labels=format(s.r, "%B\n%Y"))),
       auto.key=list(columns=4, lines=TRUE, points=FALSE),
       par.settings=tps,
       panel=function(...) {
         panel.abline(h=seq(0, 100, by=10), col='grey')
         panel.abline(v=s.r, col='grey')
         panel.xyplot(...)
       })
```


Investigate monthly levels and capacity of New Melones Reservoir.
```{r, fig.width=11, fig.height=5}
# New Melones monthly data, retrieve as far back in time as possible 
new.melones.monthly <- CDECquery(id='nml', sensor=15, interval='M', start='1900-01-01', end='2019-01-01')

# convert to pct. capacity
new.melones.monthly$capacity <- new.melones.monthly$value / 2400000 * 100

# color ramp
cols <- colorRampPalette(rev(viridis(10)), space='Lab', interpolate='spline')

# plot, each pixel is colored by the total precip by year/month
levelplot(capacity ~ year * month, data=new.melones.monthly, col.regions=cols, xlab='', ylab='', scales=list(x=list(tick.number=20)), main='New Melones Capacity (%)')
```






----------------------------
This document is based on `sharpshootR` version `r utils::packageDescription("sharpshootR", field="Version")`.


